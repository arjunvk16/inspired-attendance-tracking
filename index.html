<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading states */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        .btn-loader {
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Team Status Tracker</h1>
            <p class="text-slate-500 mt-1">Select a date to view or update the team's status.</p>
        </header>

        <!-- Date Selector -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
            <label for="date-picker" class="font-semibold text-slate-700">Select Date:</label>
            <input type="date" id="date-picker" class="w-full flex-grow bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
        </div>

        <!-- Daily Status Editor -->
        <h2 id="editor-heading" class="text-lg font-semibold text-slate-700 mb-3 hidden">Update Status for Selected Day</h2>
        <div id="employee-list-container" class="space-y-3">
            <!-- Loader will be shown here initially -->
        </div>

        <!-- Action Button and Status Message -->
        <div class="my-8 text-center">
            <button id="save-button" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 transition-colors">
                <span id="btn-text">Save Changes</span>
                <span id="btn-loader" class="hidden">
                    <div class="btn-loader"></div>
                </span>
            </button>
            <p id="status-message" class="mt-4 text-sm font-medium h-5"></p>
        </div>

        <!-- Divider -->
        <hr class="my-8">
        
        <!-- Weekly Member Summary Table -->
        <div id="table-container" class="my-8 hidden">
            <div class="flex justify-between items-center mb-3">
                 <h2 class="text-lg font-semibold text-slate-700">Weekly Member Summary <span id="weekly-date-range" class="font-normal text-base text-slate-500 ml-2"></span></h2>
            </div>
            <div id="week-selector" class="flex items-center gap-6 mb-4">
                <div class="flex items-center">
                    <input id="prev-week" type="radio" name="week-option" value="previous" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <label for="prev-week" class="ml-2 block text-sm font-medium text-gray-700">Previous Week</label>
                </div>
                <div class="flex items-center">
                    <input id="current-week" type="radio" name="week-option" value="current" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" checked>
                    <label for="current-week" class="ml-2 block text-sm font-medium text-gray-700">Current Week</label>
                </div>
                <div class="flex items-center">
                    <input id="next-week" type="radio" name="week-option" value="next" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <label for="next-week" class="ml-2 block text-sm font-medium text-gray-700">Next Week</label>
                </div>
            </div>
            <div class="border rounded-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr id="weekly-summary-header">
                            <!-- Header generated by JS -->
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Individual Monthly Report -->
        <div id="individual-report-container" class="my-8 hidden">
             <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Individual Monthly Report</h2>
                <div class="flex items-center gap-4">
                    <label for="employee-select" class="font-medium text-sm text-slate-600">Select Member:</label>
                    <select id="employee-select" class="bg-white border border-slate-300 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                    <button id="download-excel-button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Download as Excel
                    </button>
                </div>
            </div>
            <div id="individual-calendar-container" class="hidden mt-4">
                <div id="individual-monthly-summary" class="flex flex-wrap gap-x-6 gap-y-2 mb-4 text-sm"></div>
                <div id="calendar-grid-header" class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-slate-500 mb-1">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid-body" class="grid grid-cols-7 gap-1">
                    <!-- Calendar cells are dynamically generated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, setLogLevel, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202",
            measurementId: "G-D6ZRG8LK2H"
        };

        const employees = [
            "Akhil", "Arjun", "Arjun V K", "Chanthuraj", "Dayanitta",
            "Eby", "Rishil", "Shehmil", "Sumesh"
        ];
        
        // --- DOM Elements ---
        const datePicker = document.getElementById('date-picker');
        const employeeListContainer = document.getElementById('employee-list-container');
        const tableContainer = document.getElementById('table-container');
        const weeklyDateRange = document.getElementById('weekly-date-range');
        const weeklySummaryHeader = document.getElementById('weekly-summary-header');
        const summaryTableBody = document.getElementById('summary-table-body');
        const editorHeading = document.getElementById('editor-heading');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const individualReportContainer = document.getElementById('individual-report-container');
        const employeeSelect = document.getElementById('employee-select');
        const downloadExcelButton = document.getElementById('download-excel-button');
        const individualCalendarContainer = document.getElementById('individual-calendar-container');
        const monthlySummaryContainer = document.getElementById('individual-monthly-summary');
        const calendarGridBody = document.getElementById('calendar-grid-body');

        let db;
        let unsubscribe;

        // --- Main Application Logic ---
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                setLogLevel('debug');
                await signInAnonymously(auth);
                populateEmployeeDropdown();
                setupInitialDate();
                await handleDateChange(datePicker.value);
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showError("Could not connect to the database.");
            }
        }

        const formatDate = (date) => date.toISOString().split('T')[0];
        const formatDisplayDate = (date) => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        function populateEmployeeDropdown() {
            employees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeSelect.appendChild(option);
            });
        }

        function setupInitialDate() {
            datePicker.value = formatDate(new Date());
        }

        function renderEmployeeEditor(attendanceData = {}) {
            employeeListContainer.innerHTML = ''; 
            employees.forEach(name => {
                const currentStatus = attendanceData[name] || 'WFO';
                const employeeDiv = document.createElement('div');
                employeeDiv.className = 'flex items-center justify-between p-3 rounded-lg bg-slate-50 border';
                employeeDiv.innerHTML = `<span class="font-medium text-slate-800">${name}</span>
                    <select class="status-select bg-white border border-slate-300 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" data-employee-name="${name}">
                        <option value="WFO" ${currentStatus === 'WFO' ? 'selected' : ''}>🏢 Work from Office</option>
                        <option value="WFH" ${currentStatus === 'WFH' ? 'selected' : ''}>🏠 Work from Home</option>
                        <option value="Leave" ${currentStatus === 'Leave' ? 'selected' : ''}>🌴 On Leave</option>
                    </select>`;
                employeeListContainer.appendChild(employeeDiv);
            });
        }
        
        const statusBadge = (status) => {
            const styles = {
                WFO: 'bg-indigo-100 text-indigo-800',
                WFH: 'bg-sky-100 text-sky-800',
                Leave: 'bg-orange-100 text-orange-800',
                '--': 'text-slate-400'
            };
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status] || styles['--']}">${status}</span>`;
        };
        
        function renderWeeklySummaryTable(weeklyData, startDate) {
            // Render Header
            let headerHTML = `<th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Member</th>`;
            for (let i = 0; i < 7; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                headerHTML += `<th scope="col" class="px-2 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">${day.toLocaleDateString('en-US', { weekday: 'short' })}<br>${day.getDate()}</th>`;
            }
            headerHTML += `<th scope="col" class="px-2 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider border-l">WFO</th>
                           <th scope="col" class="px-2 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">WFH</th>
                           <th scope="col" class="px-2 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Leave</th>`;
            weeklySummaryHeader.innerHTML = headerHTML;
            
            // Render Body
            summaryTableBody.innerHTML = '';
            employees.forEach(name => {
                const employeeData = weeklyData[name] || { days: {}, totals: { WFO: 0, WFH: 0, Leave: 0 }, wfoWorkingDays: 0 };
                const highlightClass = employeeData.wfoWorkingDays >= 4 ? 'bg-green-50' : '';
                const row = document.createElement('tr');
                row.className = highlightClass;

                let rowHTML = `<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${name}</td>`;
                for (let i = 0; i < 7; i++) { // 0=Sun, 1=Mon...
                    const status = employeeData.days[i] || '--';
                    rowHTML += `<td class="px-2 py-3 whitespace-nowrap text-sm text-center">${statusBadge(status)}</td>`;
                }
                rowHTML += `<td class="px-2 py-3 whitespace-nowrap text-sm text-center border-l font-medium">${employeeData.totals.WFO}</td>
                            <td class="px-2 py-3 whitespace-nowrap text-sm text-center font-medium">${employeeData.totals.WFH}</td>
                            <td class="px-2 py-3 whitespace-nowrap text-sm text-center font-medium">${employeeData.totals.Leave}</td>`;
                row.innerHTML = rowHTML;
                summaryTableBody.appendChild(row);
            });
        }

        function getWeekRangeForDate(dateStr, mode = 'current') {
            const selectedDate = new Date(dateStr + 'T00:00:00');
            const dayOfWeek = selectedDate.getDay(); // Sunday = 0
            const startDate = new Date(selectedDate);
            startDate.setDate(selectedDate.getDate() - dayOfWeek); // Go back to Sunday
            if (mode === 'previous') startDate.setDate(startDate.getDate() - 7);
            else if (mode === 'next') startDate.setDate(startDate.getDate() + 7);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            return { startDate, endDate };
        }
        
        async function fetchWeeklyData(startDate, endDate) {
            weeklyDateRange.textContent = `[${formatDisplayDate(startDate)} - ${formatDisplayDate(endDate)}]`;
            const weeklyData = {};
            employees.forEach(name => { 
                weeklyData[name] = { days: {}, totals: { WFO: 0, WFH: 0, Leave: 0 }, wfoWorkingDays: 0 }; 
            });

            try {
                const q = query(collection(db, 'team_status'), where('__name__', '>=', formatDate(startDate)), where('__name__', '<=', formatDate(endDate)));
                const querySnapshot = await getDocs(q);

                querySnapshot.forEach(doc => {
                    const statuses = doc.data().statuses;
                    const docDate = new Date(doc.id + 'T00:00:00');
                    const docDayOfWeek = docDate.getDay();
                    for (const name in statuses) {
                        if (weeklyData[name] && statuses[name]) {
                            const status = statuses[name];
                            weeklyData[name].days[docDayOfWeek] = status;
                            weeklyData[name].totals[status]++;
                            if (docDayOfWeek >= 1 && docDayOfWeek <= 5 && status === 'WFO') {
                                weeklyData[name].wfoWorkingDays++;
                            }
                        }
                    }
                });
                renderWeeklySummaryTable(weeklyData, startDate);
            } catch (error) {
                console.error("Error fetching weekly summary:", error);
            }
        }

        async function fetchIndividualMonthlyData(employeeName, dateStr) {
            const selectedDate = new Date(dateStr + 'T00:00:00');
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);

            const statusByDay = {};
            const monthlyCounts = { WFO: 0, WFH: 0, Leave: 0 };

            try {
                const q = query(collection(db, 'team_status'), where('__name__', '>=', formatDate(startDate)), where('__name__', '<=', formatDate(endDate)));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => {
                    const statuses = doc.data().statuses;
                    if (statuses && statuses[employeeName]) {
                        const dayOfMonth = new Date(doc.id + 'T00:00:00').getDate();
                        const status = statuses[employeeName];
                        statusByDay[dayOfMonth] = status;
                        if(monthlyCounts[status] !== undefined) monthlyCounts[status]++;
                    }
                });
                return { statusByDay, monthlyCounts, startDate };
            } catch (error) {
                console.error('Error fetching individual monthly data:', error);
                return null;
            }
        }

        async function renderIndividualMonthlyReport() {
            const employeeName = employeeSelect.value;
            const dateStr = datePicker.value;
            if (!employeeName || !dateStr) return;

            individualCalendarContainer.classList.remove('hidden');
            const monthlyData = await fetchIndividualMonthlyData(employeeName, dateStr);
            if (!monthlyData) {
                 calendarGridBody.innerHTML = '<p class="text-red-500 col-span-7">Could not load calendar data.</p>';
                 return;
            }

            const { statusByDay, monthlyCounts, startDate } = monthlyData;
            const daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = startDate.getDay();

            monthlySummaryContainer.innerHTML = `
                <div class="flex items-center"><span class="h-3 w-3 mr-2 rounded-full bg-indigo-500"></span>WFO: <strong class="ml-1">${monthlyCounts.WFO}</strong></div>
                <div class="flex items-center"><span class="h-3 w-3 mr-2 rounded-full bg-sky-500"></span>WFH: <strong class="ml-1">${monthlyCounts.WFH}</strong></div>
                <div class="flex items-center"><span class="h-3 w-3 mr-2 rounded-full bg-orange-400"></span>Leave: <strong class="ml-1">${monthlyCounts.Leave}</strong></div>`;

            calendarGridBody.innerHTML = '';
            for (let i = 0; i < firstDayOfMonth; i++) calendarGridBody.insertAdjacentHTML('beforeend', '<div></div>');
            
            const colorClasses = { WFO: 'bg-indigo-500 text-white', WFH: 'bg-sky-500 text-white', Leave: 'bg-orange-400 text-white', NoData: 'bg-slate-100 text-slate-400' };
            for (let day = 1; day <= daysInMonth; day++) {
                const status = statusByDay[day] || 'NoData';
                const cellClass = colorClasses[status];
                calendarGridBody.insertAdjacentHTML('beforeend', `<div class="aspect-square flex items-center justify-center text-xs font-semibold rounded-md ${cellClass}">${day}</div>`);
            }
        }
        
        async function downloadMonthlyReportAsExcel() {
            const employeeName = employeeSelect.value;
            const dateStr = datePicker.value;
            const monthlyData = await fetchIndividualMonthlyData(employeeName, dateStr);
            if(!monthlyData) return alert('Could not fetch data to export.');
            
            const { statusByDay, startDate } = monthlyData;
            const daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();

            const excelData = [
                ['Date', 'Day', 'Status']
            ];

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), day);
                const dateString = currentDate.toISOString().split('T')[0];
                const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                const status = statusByDay[day] || 'No Data';
                excelData.push([dateString, dayName, status]);
            }

            const worksheet = XLSX.utils.aoa_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Monthly Report');
            const monthName = startDate.toLocaleDateString('en-US', { month: 'long' });
            XLSX.writeFile(workbook, `Monthly_Report_${employeeName}_${monthName}_${startDate.getFullYear()}.xlsx`);
        }

        async function listenForDailyData(dateStr) {
            if (unsubscribe) unsubscribe();
            const docRef = doc(db, 'team_status', dateStr);
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                renderEmployeeEditor(docSnap.exists() ? docSnap.data().statuses : {});
                hideLoadingState();
            });
        }
        
        async function handleDateChange(dateStr) {
            if (!db || !dateStr) return;
            showLoadingState();
            document.getElementById('current-week').checked = true;
            const { startDate, endDate } = getWeekRangeForDate(dateStr, 'current');
            await Promise.all([
                listenForDailyData(dateStr),
                fetchWeeklyData(startDate, endDate),
                renderIndividualMonthlyReport()
            ]);
        }

        async function saveData() {
            const selectedDate = datePicker.value;
            if (!db || !selectedDate) return;
            setButtonLoading(true);
            const statuses = {};
            document.querySelectorAll('.status-select').forEach(select => {
                statuses[select.getAttribute('data-employee-name')] = select.value;
            });
            try {
                await setDoc(doc(db, 'team_status', selectedDate), { statuses });
                showSuccess("Changes saved successfully!");
                const selectedMode = document.querySelector('input[name="week-option"]:checked').value;
                const { startDate, endDate } = getWeekRangeForDate(selectedDate, selectedMode);
                await fetchWeeklyData(startDate, endDate);
                await renderIndividualMonthlyReport();
            } catch (error) {
                showError("Failed to save changes.");
            } finally {
                setButtonLoading(false);
            }
        }

        function showLoadingState() {
            employeeListContainer.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';
            [tableContainer, editorHeading, individualReportContainer].forEach(el => el.classList.add('hidden'));
            saveButton.disabled = true;
        }

        function hideLoadingState() {
            [tableContainer, editorHeading, individualReportContainer].forEach(el => el.classList.remove('hidden'));
            saveButton.disabled = false;
        }

        function setButtonLoading(isLoading) {
            btnText.classList.toggle('hidden', isLoading);
            btnLoader.classList.toggle('hidden', !isLoading);
            saveButton.disabled = isLoading;
        }

        function showSuccess(message) {
            statusMessage.textContent = message;
            statusMessage.className = "mt-4 text-sm font-medium h-5 text-green-600";
            setTimeout(() => { statusMessage.textContent = ''; }, 3000);
        }

        function showError(message) {
            employeeListContainer.innerHTML = `<div class="text-center p-4 text-red-600 bg-red-100 rounded-lg">${message}</div>`;
            [tableContainer, editorHeading].forEach(el => el.classList.add('hidden'));
            statusMessage.textContent = message;
            statusMessage.className = "mt-4 text-sm font-medium h-5 text-red-600";
        }

        // --- Event Listeners ---
        datePicker.addEventListener('change', () => handleDateChange(datePicker.value));
        employeeSelect.addEventListener('change', renderIndividualMonthlyReport);
        downloadExcelButton.addEventListener('click', downloadMonthlyReportAsExcel);
        saveButton.addEventListener('click', saveData);
        document.querySelectorAll('input[name="week-option"]').forEach(radio => {
            radio.addEventListener('change', async () => {
                const selectedMode = radio.value;
                const { startDate, endDate } = getWeekRangeForDate(datePicker.value, selectedMode);
                await fetchWeeklyData(startDate, endDate);
            });
        });
        
        // --- Initialisation ---
        initializeFirebase();

    </script>
</body>
</html>

