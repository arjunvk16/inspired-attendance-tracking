<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading states */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        .btn-loader {
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Team Status Tracker</h1>
            <p class="text-slate-500 mt-1">Select a date to view or update the team's status.</p>
        </header>

        <!-- Date Selector -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
            <label for="date-picker" class="font-semibold text-slate-700">Select Date:</label>
            <input type="date" id="date-picker" class="w-full flex-grow bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
        </div>

        <!-- Employee List Container -->
        <div id="employee-list-container" class="space-y-3">
            <!-- Loader will be shown here initially -->
        </div>

        <!-- Action Button and Status Message -->
        <div class="mt-8 text-center">
            <button id="save-button" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 transition-colors">
                <span id="btn-text">Save Changes</span>
                <span id="btn-loader" class="hidden">
                    <div class="btn-loader"></div>
                </span>
            </button>
            <p id="status-message" class="mt-4 text-sm font-medium h-5"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuration ---
        const employees = [
            "Akhil", "Arjun", "Arjun V K", "Chanthuraj", "Dayanitta",
            "Eby", "Rishil", "Shehmil", "Sumesh"
        ];
        
        // --- Canvas Environment Variables ---
        // These are provided by the hosting environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const datePicker = document.getElementById('date-picker');
        const employeeListContainer = document.getElementById('employee-list-container');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');

        let db;

        // --- Main Application Logic ---
        
        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
             const firebaseConfig = {
                apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
                authDomain: "my-chain-reaction-game.firebaseapp.com",
                projectId: "my-chain-reaction-game",
                storageBucket: "my-chain-reaction-game.appspot.com",
                messagingSenderId: "32751418407",
                appId: "1:32751418407:web:ff8244007ef2b099d56202",
                measurementId: "G-D6ZRG8LK2H"
              };

            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                showError("Application is not configured correctly.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                setLogLevel('debug');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized and user authenticated.");
                
                // Initial load after successful setup
                setupInitialDate();
                await loadDataForDate(datePicker.value);

            } catch (error) {
                console.error("Firebase initialization error:", error);
                showError("Could not connect to the database.");
            }
        }

        /**
         * Formats a Date object into 'YYYY-MM-DD' string.
         */
        const formatDate = (date) => date.toISOString().split('T')[0];

        /**
         * Sets the date picker to today's date.
         */
        function setupInitialDate() {
            const today = new Date();
            datePicker.value = formatDate(today);
        }

        /**
         * Renders the list of employees with their current status.
         * @param {Object} attendanceData - Data from Firestore for the selected date.
         */
        function renderEmployees(attendanceData = {}) {
            employeeListContainer.innerHTML = ''; // Clear previous list or loader
            employees.forEach(name => {
                const currentStatus = attendanceData[name] || 'WFO'; // Default to 'Work from Office'
                const employeeDiv = document.createElement('div');
                employeeDiv.className = 'flex items-center justify-between p-3 rounded-lg bg-slate-50 border';

                employeeDiv.innerHTML = `
                    <span class="font-medium text-slate-800">${name}</span>
                    <select class="status-select bg-white border border-slate-300 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" data-employee-name="${name}">
                        <option value="WFO" ${currentStatus === 'WFO' ? 'selected' : ''}>üè¢ Work from Office</option>
                        <option value="WFH" ${currentStatus === 'WFH' ? 'selected' : ''}>üè† Work from Home</option>
                        <option value="Leave" ${currentStatus === 'Leave' ? 'selected' : ''}>üå¥ On Leave</option>
                    </select>
                `;
                employeeListContainer.appendChild(employeeDiv);
            });
        }
        
        /**
         * Loads attendance data from Firestore for the selected date.
         * @param {string} dateStr - The date in 'YYYY-MM-DD' format.
         */
        async function loadDataForDate(dateStr) {
            if (!db || !dateStr) return;
            
            showLoadingState();
            try {
                // All data is public for this collaborative app
                const docRef = doc(db, 'artifacts', appId, 'public/data/attendance', dateStr);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    renderEmployees(docSnap.data().statuses);
                } else {
                    renderEmployees(); // Render with default values
                }
            } catch (error) {
                console.error("Error getting document:", error);
                showError("Failed to load data.");
            } finally {
                hideLoadingState();
            }
        }

        /**
         * Saves the current state of attendance to Firestore.
         */
        async function saveData() {
            const selectedDate = datePicker.value;
            if (!db || !selectedDate) return;

            setButtonLoading(true);

            const statuses = {};
            document.querySelectorAll('.status-select').forEach(select => {
                const name = select.getAttribute('data-employee-name');
                statuses[name] = select.value;
            });

            try {
                const docRef = doc(db, 'artifacts', appId, 'public/data/attendance', selectedDate);
                await setDoc(docRef, { statuses });
                showSuccess("Changes saved successfully!");
            } catch (error) {
                console.error("Error saving document: ", error);
                showError("Failed to save changes.");
            } finally {
                setButtonLoading(false);
            }
        }

        // --- UI Helper Functions ---
        
        function showLoadingState() {
            employeeListContainer.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';
            saveButton.disabled = true;
        }

        function hideLoadingState() {
            saveButton.disabled = false;
        }

        function setButtonLoading(isLoading) {
            if (isLoading) {
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
                saveButton.disabled = true;
            } else {
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
                saveButton.disabled = false;
            }
        }

        function showSuccess(message) {
            statusMessage.textContent = message;
            statusMessage.className = "mt-4 text-sm font-medium h-5 text-green-600";
            setTimeout(() => { statusMessage.textContent = ''; }, 3000);
        }

        function showError(message) {
            employeeListContainer.innerHTML = `<div class="text-center p-4 text-red-600 bg-red-100 rounded-lg">${message}</div>`;
            statusMessage.textContent = message;
            statusMessage.className = "mt-4 text-sm font-medium h-5 text-red-600";
        }


        // --- Event Listeners ---
        datePicker.addEventListener('change', () => loadDataForDate(datePicker.value));
        saveButton.addEventListener('click', saveData);
        
        // --- Initialisation ---
        initializeFirebase();

    </script>
</body>
</html>
