<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading states */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        .btn-loader {
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <!-- Login Container -->
    <div id="login-container" class="w-full max-w-md hidden">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-2">Admin Login</h2>
            <p class="text-center text-slate-500 mb-6">Please sign in to continue.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                    <input type="email" id="username" name="username" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5" placeholder="Enter your email" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                    <input type="password" id="password" name="password" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5" placeholder="Enter password" required>
                </div>
                <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Login
                </button>
                <p id="login-error" class="mt-4 text-sm text-center font-medium h-5 text-red-600"></p>
            </form>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="w-full max-w-7xl bg-white rounded-xl shadow-lg p-6 md:p-8 hidden">
        <header class="relative text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Team Status Tracker</h1>
            <p class="text-slate-500 mt-1">Select a date to view or update the team's status.</p>
            <button id="logout-button" class="absolute top-0 right-0 inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                Logout
            </button>
        </header>

        <!-- Date Selector -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
            <label for="date-picker" class="font-semibold text-slate-700">Select Date:</label>
            <input type="date" id="date-picker" class="w-full flex-grow bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
        </div>

        <!-- Daily Status Editor -->
        <h2 id="editor-heading" class="text-lg font-semibold text-slate-700 mb-3 hidden">Update Status for Selected Day</h2>
        <div id="employee-list-container" class="space-y-3">
            <!-- Loader will be shown here initially -->
        </div>

        <!-- Action Button and Status Message -->
        <div class="my-8 text-center">
            <button id="save-button" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 transition-colors">
                <span id="btn-text">Save Changes</span>
                <span id="btn-loader" class="hidden">
                    <div class="btn-loader"></div>
                </span>
            </button>
            <p id="status-message" class="mt-4 text-sm font-medium h-5"></p>
        </div>

        <!-- Divider -->
        <hr class="my-8">
        
        <!-- Individual Monthly Report -->
        <div id="individual-report-container" class="my-8 hidden">
             <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Monthly Report</h2>
                <div class="flex items-center gap-4">
                    <button id="download-excel-button" class="inline-flex justify-center items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        <span id="download-btn-text">Download Team Report</span>
                        <span id="download-btn-loader" class="hidden"><div class="btn-loader"></div></span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                 <label for="employee-select" class="font-medium text-sm text-slate-600">View Individual Calendar:</label>
                 <select id="employee-select" class="bg-white border border-slate-300 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            <div id="individual-calendar-container" class="hidden mt-4">
                <div id="individual-monthly-summary" class="flex flex-wrap gap-x-6 gap-y-2 mb-4 text-sm"></div>
                <div id="calendar-grid-header" class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-slate-500 mb-1">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid-body" class="grid grid-cols-7 gap-1">
                    <!-- Calendar cells are dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Monthly Eligibility Report -->
        <div id="eligibility-report-container" class="my-8 hidden">
            <h2 class="text-lg font-semibold text-slate-700 mb-3">Monthly Eligibility Summary</h2>
            <div class="border rounded-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr id="eligibility-header">
                            <!-- Header generated dynamically -->
                        </tr>
                    </thead>
                    <tbody id="eligibility-body" class="bg-white divide-y divide-slate-200">
                        <!-- Body generated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, setLogLevel, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202",
            measurementId: "G-D6ZRG8LK2H"
        };

        const employees = [
            "Akhil", "Arjun", "Arjun V K", "Chanthuraj", "Dayanitta",
            "Eby", "Rishil", "Shehmil", "Sumesh"
        ];
        
        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const logoutButton = document.getElementById('logout-button');

        const datePicker = document.getElementById('date-picker');
        const employeeListContainer = document.getElementById('employee-list-container');
        const editorHeading = document.getElementById('editor-heading');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const individualReportContainer = document.getElementById('individual-report-container');
        const employeeSelect = document.getElementById('employee-select');
        const downloadExcelButton = document.getElementById('download-excel-button');
        const downloadBtnText = document.getElementById('download-btn-text');
        const downloadBtnLoader = document.getElementById('download-btn-loader');
        const individualCalendarContainer = document.getElementById('individual-calendar-container');
        const monthlySummaryContainer = document.getElementById('individual-monthly-summary');
        const calendarGridBody = document.getElementById('calendar-grid-body');
        const eligibilityReportContainer = document.getElementById('eligibility-report-container');
        const eligibilityHeader = document.getElementById('eligibility-header');
        const eligibilityBody = document.getElementById('eligibility-body');

        let db;
        let auth;
        let unsubscribeDaily;
        let isAppInitialized = false;

        // --- Main App Initialization ---
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug');

        // --- Auth State Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                if (!isAppInitialized) {
                    initializeAppLogic();
                    isAppInitialized = true;
                }
            } else {
                // User is signed out
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                isAppInitialized = false; // Reset for next login
            }
        });

        // --- Login/Logout Logic ---
        async function handleLogin(event) {
            event.preventDefault();
            const email = usernameInput.value;
            const password = passwordInput.value;
            loginError.textContent = '';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle UI changes
            } catch (error) {
                console.error("Login Error:", error.code, error.message);
                loginError.textContent = 'Invalid email or password.';
                setTimeout(() => { loginError.textContent = '' }, 3000);
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle UI changes
            } catch (error) {
                console.error("Logout Error:", error);
            }
        }
        
        // --- Core Application Logic (runs after login) ---
        async function initializeAppLogic() {
            try {
                populateEmployeeDropdown();
                setupInitialDate();
                await handleDateChange(datePicker.value);
            } catch (error) {
                console.error("App initialization error:", error);
                showError("Could not load application data.");
            }
        }

        const formatDate = (date) => date.toISOString().split('T')[0];
        
        function populateEmployeeDropdown() {
            // Clear existing options before populating
            employeeSelect.innerHTML = '';
            employees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeSelect.appendChild(option);
            });
        }

        function setupInitialDate() {
            datePicker.value = formatDate(new Date());
        }
        
        function getWeekStartDate(date) {
            const newDate = new Date(date);
            const day = newDate.getDay();
            // Adjust to Monday as the start of the week
            const diff = newDate.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(newDate.setDate(diff));
        }

        function renderEmployeeEditor(attendanceData = {}) {
            employeeListContainer.innerHTML = ''; 
            employees.forEach(name => {
                const currentStatus = attendanceData[name] || 'WFO';
                const employeeDiv = document.createElement('div');
                employeeDiv.className = 'flex items-center justify-between p-3 rounded-lg bg-slate-50 border';
                employeeDiv.innerHTML = `<span class="font-medium text-slate-800">${name}</span>
                    <select class="status-select bg-white border border-slate-300 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" data-employee-name="${name}">
                        <option value="WFO" ${currentStatus === 'WFO' ? 'selected' : ''}>üè¢ Work from Office</option>
                        <option value="WFH" ${currentStatus === 'WFH' ? 'selected' : ''}>üè† Work from Home</option>
                        <option value="Leave" ${currentStatus === 'Leave' ? 'selected' : ''}>üå¥ On Leave</option>
                    </select>`;
                employeeListContainer.appendChild(employeeDiv);
            });
        }
        
        async function fetchAllMonthlyData(dateStr) {
             const selectedDate = new Date(dateStr + 'T00:00:00');
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);
            
            const monthlyData = {};
            try {
                const q = query(collection(db, 'team_status'), where('__name__', '>=', formatDate(startDate)), where('__name__', '<=', formatDate(endDate)));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => {
                    monthlyData[doc.id] = doc.data().statuses;
                });
                return monthlyData;
            } catch (error) {
                console.error("Error fetching all monthly data:", error);
                return {};
            }
        }

        async function renderMonthlyEligibilityReport(dateStr, allMonthlyData) {
            const selectedDate = new Date(dateStr + 'T00:00:00');
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();

            const weeksOfMonth = [];
            let weekStart = getWeekStartDate(new Date(year, month, 1));
            while (weekStart.getMonth() <= month) {
                 if(weekStart.getFullYear() === year) weeksOfMonth.push(new Date(weekStart));
                 weekStart.setDate(weekStart.getDate() + 7);
            }
            
            let headerContent = `<th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Member</th>`;
            weeksOfMonth.forEach((week, index) => {
                headerContent += `<th scope="col" class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Week ${index + 1}</th>`;
            });
            headerContent += `<th scope="col" class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Total Eligible Weeks</th>`;
            eligibilityHeader.innerHTML = headerContent;

            const eligibilityData = {};
            // For each employee, calculate their weekly eligibility for the month.
            employees.forEach(name => {
                let totalEligibleWeeks = 0;
                
                // Map over each week of the month to determine if it was an "eligible" week.
                const weeklyEligibility = weeksOfMonth.map(weekStart => {
                    // This is the counter for "Work From Office" days in a single week.
                    let wfoCount = 0;

                    // --- ELIGIBILITY LOGIC ---
                    // Loop through the 5 working days of the week (Monday to Friday).
                    // i=0 is Monday, i=1 is Tuesday, ..., i=4 is Friday. This ignores Saturday and Sunday.
                    for (let i = 0; i < 5; i++) {
                        const day = new Date(weekStart);
                        day.setDate(weekStart.getDate() + i);
                        const dayStr = formatDate(day);

                        // Check the stored data for the current day.
                        // If the status for the employee on this day is 'WFO'...
                        if (allMonthlyData[dayStr] && allMonthlyData[dayStr][name] === 'WFO') {
                            // ...increment the counter.
                            wfoCount++;
                        }
                    }

                    // After checking all 5 days, see if the employee met the criteria.
                    // The requirement is to be in the office for at least 4 days.
                    if (wfoCount >= 4) {
                        totalEligibleWeeks++; // Increment the total eligible weeks for the month.
                        return '‚úì'; // Mark this week as eligible (check mark).
                    }
                    
                    // If the count is less than 4, the week is not eligible.
                    return '‚úó'; // Mark this week as not eligible (cross mark).
                });

                // Store the results for the employee.
                eligibilityData[name] = { weeklyEligibility, totalEligibleWeeks };
            });

            eligibilityBody.innerHTML = '';
            employees.forEach(name => {
                const data = eligibilityData[name];
                let rowContent = `<td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${name}</td>`;
                data.weeklyEligibility.forEach(status => {
                    const textColor = status === '‚úì' ? 'text-green-600' : 'text-red-500';
                    rowContent += `<td class="px-4 py-4 whitespace-nowrap text-sm text-center font-semibold ${textColor}">${status}</td>`;
                });
                rowContent += `<td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-slate-800">${data.totalEligibleWeeks}</td>`;
                eligibilityBody.innerHTML += `<tr>${rowContent}</tr>`;
            });
        }

        async function fetchIndividualMonthlyData(employeeName, allMonthlyData, dateStr) {
            const selectedDate = new Date(dateStr + 'T00:00:00');
            const startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

            const statusByDay = {};
            const monthlyCounts = { WFO: 0, WFH: 0, Leave: 0 };

            for(const dateKey in allMonthlyData) {
                const statuses = allMonthlyData[dateKey];
                if(statuses && statuses[employeeName]) {
                    const dayOfMonth = new Date(dateKey + 'T00:00:00').getDate();
                    const status = statuses[employeeName];
                    statusByDay[dayOfMonth] = status;
                    if(monthlyCounts[status] !== undefined) monthlyCounts[status]++;
                }
            }
            return { statusByDay, monthlyCounts, startDate };
        }

        async function renderIndividualMonthlyReport(allMonthlyData) {
            const employeeName = employeeSelect.value;
            const dateStr = datePicker.value;
            if (!employeeName || !dateStr) return;

            individualCalendarContainer.classList.remove('hidden');
            const monthlyData = await fetchIndividualMonthlyData(employeeName, allMonthlyData, dateStr);
            if (!monthlyData) {
                 calendarGridBody.innerHTML = '<p class="text-red-500 col-span-7">Could not load calendar data.</p>';
                 return;
            }

            const { statusByDay, monthlyCounts, startDate } = monthlyData;
            const daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = startDate.getDay();

            monthlySummaryContainer.innerHTML = `
                <div class="flex items-center"><span class="h-3 w-3 mr-2 rounded-full bg-indigo-500"></span>WFO: <strong class="ml-1">${monthlyCounts.WFO}</strong></div>
                <div class="flex items-center"><span class="h-3 w-3 mr-2 rounded-full bg-sky-500"></span>WFH: <strong class="ml-1">${monthlyCounts.WFH}</strong></div>
                <div class="flex items-center"><span class="h-3 w-3 mr-2 rounded-full bg-orange-400"></span>Leave: <strong class="ml-1">${monthlyCounts.Leave}</strong></div>`;

            calendarGridBody.innerHTML = '';
            for (let i = 0; i < firstDayOfMonth; i++) calendarGridBody.insertAdjacentHTML('beforeend', '<div></div>');
            
            const colorClasses = { WFO: 'bg-indigo-500 text-white', WFH: 'bg-sky-500 text-white', Leave: 'bg-orange-400 text-white', NoData: 'bg-slate-100 text-slate-400' };
            for (let day = 1; day <= daysInMonth; day++) {
                const status = statusByDay[day] || 'NoData';
                const cellClass = colorClasses[status];
                calendarGridBody.insertAdjacentHTML('beforeend', `<div class="aspect-square flex items-center justify-center text-xs font-semibold rounded-md ${cellClass}">${day}</div>`);
            }
        }
        
        async function downloadTeamMonthlyReportAsExcel() {
            setDownloadButtonLoading(true);
            const dateStr = datePicker.value;
            const workbook = XLSX.utils.book_new();

            const allMonthlyData = await fetchAllMonthlyData(dateStr);

            const allEmployeeDataPromises = employees.map(name => fetchIndividualMonthlyData(name, allMonthlyData, dateStr));
            const allEmployeeData = await Promise.all(allEmployeeDataPromises);

            let monthName, year;

            allEmployeeData.forEach((monthlyData, index) => {
                if (!monthlyData) return;
                
                const employeeName = employees[index];
                const { statusByDay, startDate } = monthlyData;
                const daysInMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0).getDate();
                
                if(!monthName) {
                    monthName = startDate.toLocaleDateString('en-US', { month: 'long' });
                    year = startDate.getFullYear();
                }

                const excelData = [['Date', 'Day', 'Status']];
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, startDate.getMonth(), day);
                    const dateString = currentDate.toISOString().split('T')[0];
                    const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                    const status = statusByDay[day] || 'No Data';
                    excelData.push([dateString, dayName, status]);
                }
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(workbook, worksheet, employeeName);
            });

            XLSX.writeFile(workbook, `Team_Monthly_Report_${monthName}_${year}.xlsx`);
            setDownloadButtonLoading(false);
        }

        async function listenForDailyData(dateStr) {
            if (unsubscribeDaily) unsubscribeDaily();
            const docRef = doc(db, 'team_status', dateStr);
            unsubscribeDaily = onSnapshot(docRef, (docSnap) => {
                renderEmployeeEditor(docSnap.exists() ? docSnap.data().statuses : {});
                hideLoadingState();
            });
        }
        
        async function handleDateChange(dateStr) {
            if (!db || !dateStr) return;
            showLoadingState();
            
            const allMonthlyData = await fetchAllMonthlyData(dateStr);
            
            await Promise.all([
                listenForDailyData(dateStr),
                renderIndividualMonthlyReport(allMonthlyData),
                renderMonthlyEligibilityReport(dateStr, allMonthlyData)
            ]);
        }

        async function saveData() {
            const selectedDate = datePicker.value;
            if (!db || !selectedDate) return;
            setButtonLoading(true);
            const statuses = {};
            document.querySelectorAll('.status-select').forEach(select => {
                statuses[select.getAttribute('data-employee-name')] = select.value;
            });
            try {
                await setDoc(doc(db, 'team_status', selectedDate), { statuses });
                showSuccess("Changes saved successfully!");
                const allMonthlyData = await fetchAllMonthlyData(selectedDate);
                await renderIndividualMonthlyReport(allMonthlyData);
                await renderMonthlyEligibilityReport(selectedDate, allMonthlyData);
            } catch (error) {
                showError("Failed to save changes.");
            } finally {
                setButtonLoading(false);
            }
        }

        function showLoadingState() {
            employeeListContainer.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';
            [editorHeading, individualReportContainer, eligibilityReportContainer].forEach(el => el.classList.add('hidden'));
            saveButton.disabled = true;
        }

        function hideLoadingState() {
            [editorHeading, individualReportContainer, eligibilityReportContainer].forEach(el => el.classList.remove('hidden'));
            saveButton.disabled = false;
        }

        function setButtonLoading(isLoading) {
            btnText.classList.toggle('hidden', isLoading);
            btnLoader.classList.toggle('hidden', !isLoading);
            saveButton.disabled = isLoading;
        }
        
        function setDownloadButtonLoading(isLoading) {
            downloadBtnText.classList.toggle('hidden', isLoading);
            downloadBtnLoader.classList.toggle('hidden', !isLoading);
            downloadExcelButton.disabled = isLoading;
        }

        function showSuccess(message) {
            statusMessage.textContent = message;
            statusMessage.className = "mt-4 text-sm font-medium h-5 text-green-600";
            setTimeout(() => { statusMessage.textContent = ''; }, 3000);
        }

        function showError(message) {
            employeeListContainer.innerHTML = `<div class="text-center p-4 text-red-600 bg-red-100 rounded-lg">${message}</div>`;
            [editorHeading, individualReportContainer, eligibilityReportContainer].forEach(el => el.classList.add('hidden'));
            statusMessage.textContent = message;
            statusMessage.className = "mt-4 text-sm font-medium h-5 text-red-600";
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        datePicker.addEventListener('change', () => handleDateChange(datePicker.value));
        employeeSelect.addEventListener('change', async () => {
             const allMonthlyData = await fetchAllMonthlyData(datePicker.value);
             renderIndividualMonthlyReport(allMonthlyData);
        });
        downloadExcelButton.addEventListener('click', downloadTeamMonthlyReportAsExcel);
        saveButton.addEventListener('click', saveData);

    </script>
</body>
</html>
